<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solana Voice Hub</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: #fff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow-x: hidden;
    }
    .container {
      display: flex;
      width: 95%;
      max-width: 1300px;
      background: rgba(255, 255, 255, 0.15);
      padding: 35px;
      border-radius: 25px;
      box-shadow: 0 0 50px rgba(0, 255, 204, 0.9);
      backdrop-filter: blur(20px);
      animation: fadeIn 1.2s ease-in;
      position: relative;
    }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    #logo {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 120px;
      height: 120px;
      transition: transform 0.5s;
    }
    #logo:hover { transform: rotate(360deg) scale(1.1); }
    .main-content {
      flex: 3;
      padding-right: 30px;
    }
    .voice-sidebar {
      flex: 1;
      padding-left: 30px;
      border-left: 3px solid #00ffcc;
    }
    h1 {
      text-align: center;
      color: #00ffcc;
      text-shadow: 0 0 20px #00ffcc;
      font-size: 3em;
      margin-bottom: 25px;
    }
    #userCount {
      text-align: center;
      font-size: 1.4em;
      color: #00ccaa;
      margin-bottom: 15px;
    }
    .input-group, .chat-group, .kick-group, .links {
      margin: 25px 0;
    }
    input, textarea, select {
      width: 100%;
      padding: 16px;
      border: 3px solid #00ffcc;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      font-size: 18px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #00ccaa;
      box-shadow: 0 0 15px #00ccaa;
      outline: none;
    }
    textarea { height: 140px; resize: none; }
    button, a.button {
      padding: 16px 35px;
      margin: 10px;
      background: linear-gradient(45deg, #00ffcc, #00ccaa);
      color: #0f0c29;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s;
    }
    button:hover, a.button:hover {
      box-shadow: 0 0 30px #00ffcc;
      transform: scale(1.08);
    }
    #status, #tokenInfo, #coinStats {
      margin: 20px 0;
      font-size: 20px;
      text-align: center;
      color: #00ccaa;
    }
    #chatBox {
      max-height: 300px;
      overflow-y: auto;
      background: rgba(0, 255, 204, 0.2);
      border-radius: 12px;
      padding: 20px;
      list-style: none;
      border: 2px solid #00ffcc;
    }
    #chatBox li {
      display: flex;
      align-items: center;
      padding: 15px;
      margin: 10px 0;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 10px;
    }
    #typingIndicator {
      font-size: 16px;
      color: #00ccaa;
      margin-top: 10px;
    }
    #voiceUsers {
      list-style: none;
      padding: 0;
      max-height: 450px;
      overflow-y: auto;
    }
    #voiceUsers li {
      display: flex;
      align-items: center;
      margin: 15px 0;
      cursor: pointer;
    }
    #voiceUsers img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-right: 15px;
      transition: box-shadow 0.2s;
    }
    #voiceUsers img.speaking {
      box-shadow: 0 0 20px #00ffcc;
    }
    #voiceUsers img.muted {
      opacity: 0.6;
    }
    .mute-btn {
      padding: 8px 15px;
      font-size: 14px;
      background: #ff5555;
    }
    .mute-btn:hover {
      background: #ff7777;
    }
    .kick-group { display: none; }
    .kick-group.active { display: block; }
    #volumeMeter {
      width: 100%;
      height: 15px;
      background: #333;
      border-radius: 8px;
      margin-top: 15px;
    }
    #volumeMeter div {
      height: 100%;
      background: #00ffcc;
      border-radius: 8px;
      width: 0;
      transition: width 0.1s;
    }
    #loginScreen {
      text-align: center;
      padding: 50px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 20px;
      box-shadow: 0 0 25px rgba(0, 255, 204, 0.6);
      animation: slideUp 0.8s ease-out;
    }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    #loginScreen input {
      width: 85%;
      max-width: 450px;
      margin: 25px auto;
    }
    #loginScreen p {
      font-size: 1.3em;
      color: #00ccaa;
      margin-bottom: 25px;
      text-shadow: 0 0 10px #00ccaa;
    }
    .footer {
      position: fixed;
      bottom: 20px;
      width: 100%;
      text-align: center;
      font-size: 14px;
      color: #00ccaa;
    }
    @media (max-width: 800px) {
      .container { flex-direction: column; padding: 20px; }
      .voice-sidebar { border-left: none; border-top: 3px solid #00ffcc; padding-top: 30px; padding-left: 0; }
      #logo { width: 80px; height: 80px; top: 10px; right: 10px; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <!-- New Logo: Glowing "S" with Microphone Flair -->
    <img id="logo" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDUiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwZmZjYyIgc3Ryb2tlLXdpZHRoPSI2IiBzdHJva2UtZGFzaGFycmF5PSI1LDUiLz48cGF0aCBkPSJNIDQwIDI1IEMgNDAgMTUgNTAgMTAgNTAgMjUgTCA1MCA3NSBDIDUwIDg1IDQwIDkwIDQwIDc1IiBzdHJva2U9IiMwMGZmY2MiIHN0cm9rZS13aWR0aD0iOCIgZmlsbD0ibm9uZSIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIi8+PHBhdGggZD0iTSAzNSAyNSBMIDY1IDI1IiBzdHJva2U9IiMwMGZmY2MiIHN0cm9rZS13aWR0aD0iNCIvPjxwYXRoIGQ9Ik0gMzUgNzUgTCA2NSA3NSIgc3Ryb2tlPSIjMDBmZmNjIiBzdHJva2Utd2lkdGg9IjQiLz48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI2IiBmaWxsPSIjMDBmZmNjIi8+PC9zdmc+" alt="Solana Voice Hub Logo">
    <div id="loginScreen">
      <h1>Solana Voice Hub</h1>
      <p>Join the Future of Crypto Communities</p>
      <input type="text" id="usernameInput" placeholder="Enter your username">
      <button id="loginBtn">Enter the Hub</button>
    </div>
    <div id="chatScreen" style="display:none;" class="main-content">
      <h1>Solana Voice Hub</h1>
      <p id="userCount">Users Online: 0</p>
      <div class="input-group">
        <input type="text" id="contractAddress" placeholder="Enter Solana Address (e.g., 4k3D...)">
        <button id="joinBtn">Join Voice Chat</button>
        <button id="leaveBtn" style="display:none;">Leave Room</button>
        <button id="muteBtn" style="display:none;">Mute</button>
      </div>
      <p id="status">Enter a Solana address to connect!</p>
      <p id="tokenInfo"></p>
      <p id="coinStats"></p>
      <div class="kick-group">
        <select id="kickSelect"></select>
        <button id="voteKickBtn">Vote to Kick</button>
      </div>
      <div class="chat-group">
        <ul id="chatBox"></ul>
        <textarea id="chatInput" placeholder="Send a message..."></textarea>
        <p id="typingIndicator"></p>
        <button id="sendMsgBtn">Send</button>
      </div>
      <div id="volumeMeter"><div></div></div>
      <div class="links">
        <a href="https://twitter.com/SolanaVoiceHub" target="_blank" class="button">Twitter</a>
        <a href="#roadmap" id="docsBtn" class="button">Docs & Roadmap</a>
      </div>
    </div>
    <div id="voiceSidebar" class="voice-sidebar" style="display:none;">
      <h2>Voice Chat</h2>
      <ul id="voiceUsers"></ul>
    </div>
    <div id="roadmapScreen" style="display:none;" class="main-content">
      <h1>Roadmap & Vision</h1>
      <p>Connecting Solana communities through voice and text.</p>
      <ul>
        <li><strong>Phase 1: Launch (Now)</strong> - Core chat features.</li>
        <li><strong>Phase 2: Integrations (Q2 2025)</strong> - Trading tools.</li>
        <li><strong>Phase 3: Growth (Q3 2025)</strong> - Enhanced community features.</li>
        <li><strong>Phase 4: Expansion (Q4 2025)</strong> - Multi-chain support.</li>
      </ul>
      <button id="backBtn">Back to Chat</button>
    </div>
  </div>
  <div class="footer">Â© 2025 Solana Voice Hub | Powered by xAI</div>

  <script src="https://solana-voice-hub-node.onrender.com/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const socket = io('https://solana-voice-hub-node.onrender.com', { reconnection: true });
    const peer = new Peer({
      host: 'solana-voice-hub-node.onrender.com',
      path: '/peerjs',
      secure: true,
      debug: 2
    });
    let myStream, address, username, avatar = `https://api.dicebear.com/9.x/bottts/svg?seed=${Math.random()}`;
    let typingTimeout, mutedUsers = {};

    const loginBtn = document.getElementById('loginBtn');
    const joinBtn = document.getElementById('joinBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const muteBtn = document.getElementById('muteBtn');
    const sendMsgBtn = document.getElementById('sendMsgBtn');
    const voteKickBtn = document.getElementById('voteKickBtn');
    const docsBtn = document.getElementById('docsBtn');
    const backBtn = document.getElementById('backBtn');
    const chatInput = document.getElementById('chatInput');
    const volumeMeter = document.getElementById('volumeMeter').querySelector('div');

    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        myStream = stream;
        console.log('[Client] Mic access granted');
        const audioContext = new AudioContext();
        const analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(analyser);
        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        function updateVolume() {
          analyser.getByteFrequencyData(dataArray);
          const average = dataArray.reduce((a, b) => a + b) / bufferLength;
          volumeMeter.style.width = `${(average / 255) * 100}%`;
          const speaking = average > 20;
          updateVoiceUser(peer.id, speaking);
          requestAnimationFrame(updateVolume);
        }
        updateVolume();
        document.getElementById('status').textContent = 'Mic ready - enter a Solana address!';
      })
      .catch(err => {
        console.error('[Client] Mic access denied:', err);
        document.getElementById('status').textContent = 'Mic unavailable - please allow access or check settings.';
      });

    peer.on('open', id => {
      console.log('[Client] My peer ID:', id);
      socket.emit('userConnected', { peerId: id, username, avatar });
    });
    peer.on('error', err => console.error('[Client] PeerJS error:', err));

    socket.on('connect', () => console.log('[Client] Socket connected:', socket.id));
    socket.on('connect_error', err => console.error('[Client] Socket connect error:', err));

    loginBtn.onclick = () => {
      username = document.getElementById('usernameInput').value.trim();
      if (!username) return;
      console.log('[Client] Logging in as:', username);
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('chatScreen').style.display = 'block';
      socket.emit('userConnected', { peerId: peer.id || 'pending', username, avatar });
    };

    joinBtn.onclick = () => joinRoom();
    leaveBtn.onclick = leaveRoom;
    muteBtn.onclick = toggleMute;
    sendMsgBtn.onclick = sendMessage;
    voteKickBtn.onclick = () => {
      const targetId = document.getElementById('kickSelect').value;
      if (targetId) {
        console.log('[Client] Voting to kick:', targetId);
        socket.emit('voteKick', { address, targetId });
      }
    };
    docsBtn.onclick = () => {
      document.getElementById('chatScreen').style.display = 'none';
      document.getElementById('voiceSidebar').style.display = 'none';
      document.getElementById('roadmapScreen').style.display = 'block';
    };
    backBtn.onclick = () => {
      document.getElementById('roadmapScreen').style.display = 'none';
      document.getElementById('chatScreen').style.display = 'block';
      document.getElementById('voiceSidebar').style.display = address ? 'block' : 'none';
    };

    chatInput.oninput = () => {
      if (!address) return;
      clearTimeout(typingTimeout);
      socket.emit('typing', { address, username });
      typingTimeout = setTimeout(() => socket.emit('stopTyping', { address }), 1000);
    };

    function joinRoom() {
      address = document.getElementById('contractAddress').value.trim();
      if (!/^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(address)) {
        document.getElementById('status').textContent = 'Invalid Solana address!';
        return;
      }
      console.log('[Client] Joining room:', address);
      socket.emit('joinRoom', { address, peerId: peer.id, avatar, username });
      document.getElementById('status').textContent = `Joining ${address}...`;
      toggleControls(true);
      document.getElementById('voiceSidebar').style.display = 'block';
      fetchTokenInfo(address);
      fetchCoinStats(address);
    }

    function leaveRoom() {
      socket.emit('leaveRoom', { address, peerId: peer.id });
      if (myStream) myStream.getTracks().forEach(track => track.stop());
      document.getElementById('status').textContent = 'You have left the room!';
      document.getElementById('chatBox').innerHTML = '';
      document.getElementById('voiceUsers').innerHTML = '';
      document.getElementById('tokenInfo').textContent = '';
      document.getElementById('coinStats').textContent = '';
      document.getElementById('voiceSidebar').style.display = 'none';
      toggleControls(false);
      address = null;
      mutedUsers = {};
    }

    let muted = false;
    function toggleMute() {
      if (!myStream) return;
      muted = !muted;
      myStream.getAudioTracks()[0].enabled = !muted;
      muteBtn.textContent = muted ? 'Unmute' : 'Mute';
    }

    function toggleControls(show) {
      leaveBtn.style.display = show ? 'inline' : 'none';
      muteBtn.style.display = show ? 'inline' : 'none';
      document.getElementById('chatInput').style.display = show ? 'block' : 'none';
      sendMsgBtn.style.display = show ? 'inline' : 'none';
      document.getElementById('kickSelect').parentElement.classList.toggle('active', show);
    }

    socket.on('roomUpdate', data => {
      console.log('[Client] Room update:', data);
      document.getElementById('status').textContent = `Connected to ${data.address} - ${data.users.length} in room`;
      document.getElementById('userCount').textContent = `Users Online: ${data.totalUsers}`;
      updateVoiceUsers(data.users);
      updateChatBox(data.messages);
      updateKickDropdown(data.users);
    });

    socket.on('userJoined', user => {
      console.log('[Client] User joined:', user);
      document.getElementById('status').textContent += ` - ${user.username} joined!`;
    });

    socket.on('userLeft', id => {
      console.log('[Client] User left:', id);
      document.getElementById('status').textContent += ` - User left!`;
      delete mutedUsers[id];
    });

    socket.on('userKicked', userId => {
      if (socket.id === userId) leaveRoom();
      document.getElementById('status').textContent += ` - User kicked!`;
    });

    socket.on('voteUpdate', ({ targetId, votes }) => {
      const userItem = document.querySelector(`#voiceUsers li[data-id="${targetId}"]`);
      if (userItem) {
        let voteSpan = userItem.querySelector('#voteStatus');
        if (!voteSpan) {
          voteSpan = document.createElement('span');
          voteSpan.id = 'voteStatus';
          voteSpan.style.marginLeft = 'auto';
          voteSpan.style.padding = '5px 10px';
          voteSpan.style.background = '#ff9900';
          voteSpan.style.borderRadius = '5px';
          userItem.appendChild(voteSpan);
        }
        voteSpan.textContent = `${votes}/10 votes`;
      }
    });

    socket.on('newMessage', messages => {
      console.log('[Client] New messages:', messages);
      updateChatBox(messages);
    });

    socket.on('typingUpdate', typingUsers => {
      document.getElementById('typingIndicator').textContent = 
        typingUsers.length > 0 ? `${typingUsers.join(', ')} typing...` : '';
    });

    function updateVoiceUsers(users) {
      const voiceUsers = document.getElementById('voiceUsers');
      voiceUsers.innerHTML = '';
      console.log('[Client] Updating voice users:', users);
      users.forEach(user => {
        const li = document.createElement('li');
        li.dataset.id = user.id;
        li.dataset.peerId = user.peerId;
        const img = document.createElement('img');
        img.src = user.avatar || 'https://via.placeholder.com/60';
        img.alt = user.username;
        if (user.muted || mutedUsers[user.id]) img.classList.add('muted');
        li.appendChild(img);
        const nameSpan = document.createElement('span');
        nameSpan.textContent = user.username;
        li.appendChild(nameSpan);
        const muteBtn = document.createElement('button');
        muteBtn.classList.add('mute-btn');
        muteBtn.textContent = user.muted || mutedUsers[user.id] ? 'Unmute' : 'Mute';
        muteBtn.onclick = () => {
          socket.emit('muteUser', { address, targetId: user.id });
          mutedUsers[user.id] = !mutedUsers[user.id];
          muteBtn.textContent = mutedUsers[user.id] ? 'Unmute' : 'Mute';
          if (mutedUsers[user.id] && peerCalls[user.peerId]) peerCalls[user.peerId].audioTrack.enabled = false;
          else if (peerCalls[user.peerId]) peerCalls[user.peerId].audioTrack.enabled = true;
        };
        li.appendChild(muteBtn);
        voiceUsers.appendChild(li);

        if (user.peerId && user.peerId !== peer.id && myStream) {
          console.log('[Client] Calling peer:', user.peerId);
          const call = peer.call(user.peerId, myStream);
          if (call) {
            peerCalls[user.peerId] = call;
            call.on('stream', remoteStream => {
              console.log('[Client] Received stream from:', user.peerId);
              const audio = new Audio();
              audio.srcObject = remoteStream;
              audio.autoplay = true;
              if (mutedUsers[user.id]) audio.muted = true;
              audio.onplaying = () => detectSpeaking(remoteStream, user.peerId);
              document.body.appendChild(audio);
            });
            call.on('error', err => console.error('[Client] Call error:', err));
          }
        }
      });
    }

    let peerCalls = {};

    function updateKickDropdown(users) {
      const kickSelect = document.getElementById('kickSelect');
      kickSelect.innerHTML = '<option value="">Select user to kick</option>';
      console.log('[Client] Updating kick dropdown:', users);
      users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id; // Use socket.id, not peerId
        option.textContent = user.username;
        kickSelect.appendChild(option);
      });
    }

    function updateChatBox(messages) {
      const chatBox = document.getElementById('chatBox');
      chatBox.innerHTML = '';
      console.log('[Client] Updating chat:', messages);
      if (messages && messages.length > 0) {
        messages.forEach(msg => {
          const li = document.createElement('li');
          li.textContent = `${msg.username}: ${msg.text}`;
          chatBox.appendChild(li);
        });
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    }

    function sendMessage() {
      const msg = chatInput.value.trim();
      if (msg && address) {
        console.log('[Client] Sending message:', msg);
        socket.emit('chatMessage', { address, message: msg, username });
        chatInput.value = '';
        socket.emit('stopTyping', { address });
      }
    }

    function updateVoiceUser(peerId, speaking) {
      const userItem = document.querySelector(`#voiceUsers li[data-peer-id="${peerId}"] img`);
      if (userItem) userItem.classList.toggle('speaking', speaking && !mutedUsers[peerId]);
    }

    function detectSpeaking(stream, peerId) {
      const audioContext = new AudioContext();
      const analyser = audioContext.createAnalyser();
      const source = audioContext.createMediaStreamSource(stream);
      source.connect(analyser);
      analyser.fftSize = 256;
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      function checkVolume() {
        analyser.getByteFrequencyData(dataArray);
        const average = dataArray.reduce((a, b) => a + b) / bufferLength;
        const speaking = average > 20;
        updateVoiceUser(peerId, speaking);
        requestAnimationFrame(checkVolume);
      }
      checkVolume();
    }

    async function fetchTokenInfo(address) {
      try {
        const response = await fetch(`https://public-api.solscan.io/token/meta?address=${address}`);
        if (!response.ok) throw new Error('Token fetch failed');
        const data = await response.json();
        document.getElementById('tokenInfo').textContent = data.name ? `${data.name} (${data.symbol || 'N/A'})` : 'Token info unavailable';
      } catch (err) {
        document.getElementById('tokenInfo').textContent = 'Token info unavailable';
      }
    }

    async function fetchCoinStats(address) {
      try {
        const response = await fetch(`https://api.coingecko.com/api/v3/coins/solana/contract/${address}`);
        if (!response.ok) throw new Error('Coin stats fetch failed');
        const data = await response.json();
        document.getElementById('coinStats').textContent = `Market Cap: $${data.market_data.market_cap.usd.toLocaleString()} | 24h: ${data.market_data.price_change_percentage_24h.toFixed(2)}%`;
      } catch (err) {
        document.getElementById('coinStats').textContent = 'Stats unavailable';
      }
    }

    peer.on('call', call => {
      console.log('[Client] Receiving call from:', call.peer);
      if (myStream) {
        call.answer(myStream);
        call.on('stream', remoteStream => {
          console.log('[Client] Stream received from:', call.peer);
          const audio = new Audio();
          audio.srcObject = remoteStream;
          audio.autoplay = true;
          if (mutedUsers[call.peer]) audio.muted = true;
          audio.onplaying = () => detectSpeaking(remoteStream, call.peer);
          document.body.appendChild(audio);
          peerCalls[call.peer] = { audioTrack: remoteStream.getAudioTracks()[0] };
        });
        call.on('error', err => console.error('[Client] Call error:', err));
      }
    });
  </script>
</body>
</html>
